---
title: "Function Testing"
author: "Shijia Zhang"
date: "2024-03-10"
output: html_document
---

```{r}
library(dplyr)
library(readxl)
library(tidyverse)
library(lubridate)
source("adm_main.R")
source("adm_helper.R")
```

# Testing for Date input 


# Testing for simple sample data from ADNI

```{r}
sample_path = "sample_data"

src_table = get_src_table(path =sample_path,ID_pattern = "ID",DATE_pattern = "VISDATE",ID_usr_list = c("RID"),DATE_usr_list = c("VISDATE"))

src_table

ad_data = ad_merge(sample_path, DATE_type = "Date",dict_src = src_table)


ad_data$analysis_data
# 
# key_ID = get_key_IDs(src_table)
```

# Testing for biocard internal validation
```{r}
biocard_path = "BIOCARD August 2021 internal"

src_table = get_src_table(path = biocard_path,ID_pattern = "ID",DATE_pattern = "Date",ID_usr_list = c("study_id","SUBJECT_ID"))

ad_data = ad_merge(biocard_path, DATE_type = "Date",dict_src = src_table)

src_table


ad_data$analysis_data
```

# Testing for multiple sources of ANDI datasets


```{r}
ADNI_path = "ADNI data"

src_table = get_src_table(path = ADNI_path,ID_pattern = "ID",DATE_pattern = "Date",ID_usr_list = c("RID"),DATE_usr_list = c("EXAMDATE"))

print(src_table)

src_table$DATE_for_merge[src_table$file == "CDR_15Feb2024"] <- "VISDATE"

src_table


ad_data = ad_merge(ADNI_path, DATE_type = "Date",dict_src = src_table,timeline_file = "MRIMETA_15Mar2024")

ad_data$analysis_data %>% select(ID_merged,Date_timeline,ABETA42)

ad_data$analysis_data$AB40
```

# Testing for Biocard external (Join with Visit Number)

```{r}
biocard_external_path = "Biocard_External"

src_table = get_src_table(path = biocard_external_path,ID_pattern = "ID",DATE_pattern = "VISIT",ID_usr_list = c("JHUANONID"), DATE_usr_list = c("VISITNO"))

src_table

ad_data = ad_merge(biocard_external_path, DATE_type = "Number",dict_src = src_table,timeline_file = "BIOCARD_Amyloid_PET_Scan_Dates_Limited_2021.12.13")

ad_data$analysis_data

```

# Scatter plot for two different csf file.

```{r}
library(ggplot2)
library(data.table)
csf_data <- fread("ADNI data/UPENNBIOMK_ROCHE_ELECSYS_15Mar2024.csv")



csf_data %>% ggplot()+geom_point(aes(x = EXAMDATE, y = RID, color = PHASE))
```

# Merge the MRI data and the diagnosis

```{r}
mri_diag_path = "ADNI_Image_merge"


src_table = get_src_table(path = mri_diag_path,ID_pattern = "ID",DATE_pattern = "Date",ID_usr_list = c("RID"),DATE_usr_list = c("EXAMDATE"),WINDOW_list = 366,IS_overlap_list = FALSE)

ad_data = ad_merge(mri_diag_path, DATE_type = "Date",dict_src = src_table,timeline_file = "MRIMETA_21Mar2024")

ad_data$analysis_data 
```

```{r}
MRIMETA_15Mar2024 %>% filter(RID == 40)
```


```{r}
DXSUM_PDXCONV_21Mar2024 %>% filter(RID == 40)
```



```{r}
MRIMETA_15Mar2024 %>% filter(RID == 40)
```




```{r}
##########


data = get_key_DATEs(src_table,timeline_file = "BIOCARD CSF_Lumipulse Data with dates_081320_pre1995Removed",DATE_type = "Date")

data

data = get_key_IDs(src_table)

data 

data %>% filter(!is.na(study_id))

#### TODO: 把这个generate id都改成一个column name, 在function里，直接改column name





##########

name_ID = na.omit(unique(unlist(strsplit(src_table$ID_for_merge, ", "))))
 

key_ID = data.frame(matrix("NA", nrow = 0, ncol = length(name_ID)))

colnames(key_ID) = name_ID

dat_list = src_table$file
 
for (dat in dat_list) {
    dat_ID = eval(as.name(dat)) %>%
      select(any_of(name_ID)) %>%
      mutate(across(everything(), as.character)) # regard all IDs as characters
    if (ncol(dat_ID) == 0) {
      next
    }
    merge_ID = names(dat_ID)
    key_ID = key_ID %>%
      full_join(dat_ID, by = merge_ID, multiple = "all") %>% 
      distinct()
}

ad_data$analysis_data 

ids = key_ID$study_id + key_ID$SUBJECT_ID
```

```{r}
BIOCARD_CognitiveData_2021.11.02 %>% filter(SUBJECT_ID == 121)
```
```{r}
biocard_path = "BIOCARD August 2021 internal"

src_table = get_src_table(path = biocard_path,ID_pattern = "ID",DATE_pattern = "Date",ID_usr_list = c("SUBJECT_ID"))

ad_data = ad_merge(biocard_path, DATE_type = "Date",dict_src = src_table)

ad_data$analysis_data
```

```{r}
src_table
```

```{r}
Sys.Date()-(Sys.Date()-366/2)
window_len = 366
Sys.Date()-(Sys.Date()-window_len/2)

366/2
```

